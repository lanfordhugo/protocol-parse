---
alwaysApply: false
---
# 协议配置管理统一规则

## 核心工具链

- **分析工具**: `tools/cmd_analysis.py -c <配置文件> -d <协议文档>`
- **配置文件**: `configs/<协议名>/protocol.yaml` (YAML格式)
- **协议文档**: `protocoltxt/<文档名>.txt` (文本格式)

## 工作优先级

### 1. 差异修复优先（首要任务）

运行分析工具后，按严重程度处理不一致问题：

- 🔥 **字段长度不匹配** - 立即修复，影响解析正确性
- 🟡 **字段名称差异** - 批量修复，以协议文档为准
- 🔵 **缺失/多余字段** - **首先识别是否为同一事务的不同描述**：
  - ✅ 若为同一事务不同表述，统一到协议文档的确切描述
  - ✅ 若确实缺失，添加协议要求的字段
  - ✅ 若确实多余，移除无效字段
  - ⚠️  大量"缺失+多余"且语义相似时，优先考虑描述不一致

### 2. 功能补充其次（扩展任务）

在配置质量稳定后进行：

- 🔥 **高优先级CMD**: 基础通信、核心功能、安全相关
- 🟡 **中优先级CMD**: 扩展功能、调试功能、配置管理
- 🔵 **低优先级CMD**: 高级功能、特殊场景、预留扩展

## 配置文件标准

### YAML结构

```yaml
types:      # 自定义数据类型
enums:      # 枚举定义
cmds:       # CMD定义
  <号码>:
    - {len: <字节>, name: <字段名>, type: <类型>, ...}
```

### 字段属性

- **len**: 字段长度（必需，与协议文档一致）
- **name**: 字段名称（必需，使用协议文档确切名称）
- **type**: 数据类型（必需，如uint8/uint16/ascii等）
- **scale**: 比例因子（可选，如0.1）
- **enum**: 枚举引用（可选）
- **notes**: 备注说明（可选）

### 重复结构

```yaml
# 变长重复
- {len: 1, name: 数量, type: uint8, id: count}
- repeat_by: count
  fields:
    - {len: 2, name: 数据, type: uint16}

# 定长重复
- repeat_const: 8
  fields:
    - {len: 2, name: 温度, type: uint16}
```

## 标准操作流程

### 执行分析

```bash
# 完整分析
python tools/cmd_analysis.py -c configs/<协议>/protocol.yaml -d protocoltxt/<文档>.txt

# CMD范围过滤分析
python tools/cmd_analysis.py -c configs/<协议>/protocol.yaml -d protocoltxt/<文档>.txt --cmd-range <范围>
```

**CMD范围过滤功能**:
- 支持范围格式: `1-99`, `100-299`, `500+`
- 支持列表格式: `1,5,10,20`
- 用于模块化分析和问题定位
- 适合渐进式修复策略

### 解读结果

- **覆盖率**: 目标 >80%（核心功能 >90%）
- **字段不匹配**: 应持续减少至零
- **缺失CMD**: 按优先级补充
- **同一事务识别**: 大量"缺失+多余"字段且语义相似时，优先考虑描述不一致

### 同一事务识别与修正流程

#### 步骤1: 快速识别

- 观察"缺失字段"和"多余字段"的数量比例
- 检查字段名称的核心关键词是否相似
- 分析字段是否属于同一功能模块

#### 步骤2: 语义对比

```text
缺失: BRM-BMS通讯协议版本号    →    多余: BRM_BMS通讯协议版本号
缺失: 结果                   →    多余: 应答结果  
缺失: 工作状态               →    多余: 当前状态
```

#### 步骤3: 批量修正

- 建立字段名称映射表
- 在配置文件中批量替换为协议文档的确切名称
- 保持字段长度和类型不变

### 修复原则

1. **以协议文档为准** - 配置必须与官方文档对齐
2. **小步快跑** - 每次修改后立即验证
3. **保持一致性** - 统一的命名和格式标准

## 常见问题快速解决

### CMD识别失败

检查协议文档中的标识格式，工具支持：

- `cmd=数字` 格式
- `（数字）` 格式

### 字段解析错误

确认表格格式：`| 序号 | 字段定义 | 长度 | 说明 |`

### 长度不匹配

以协议文档为准，逐一核对字段长度定义

### 命名不一致（同一事务的不同描述）

**问题识别**: 工具可能将**表示同一事务但描述不一致**的字段误报为"缺失/多余"

**常见不一致模式**:

- **分隔符差异**: `BRM-BMS通讯协议版本号` vs `BRM_BMS通讯协议版本号`
- **简写差异**: `BR-电池类型` vs `BRM_电池类型`
- **格式差异**: `BRM-电池组生厂日期：年` vs `BRM_电池组生厂日期_年`
- **表述差异**: `结果` vs `应答结果`、`工作状态` vs `当前状态`
- **顺序差异**: 相同字段在不同位置或分组

**识别方法**:

1. **语义相似度**: 核心关键词基本相同（如都包含"BRM"、"电池"、"版本号"）
2. **字段数量对等**: "缺失"和"多余"字段数量相近或匹配
3. **上下文逻辑**: 字段在相同的功能模块或数据结构中

**处理策略**:

1. **优先语义分析** - 识别同一事务的不同表述方式
2. **统一到协议文档** - 配置文件严格使用协议文档的确切字段名称
3. **批量映射修正** - 建立字段名称对应关系进行批量替换
4. **人工确认机制** - 复杂情况下需要人工确认是否为同一事务

## 质量要求

- **零容忍**: 字段长度不匹配必须为零
- **高一致性**: 字段名称与协议文档完全对应
- **语义准确**: 优先识别同一事务的不同描述，避免误报缺失/多余
- **版本同步**: 配置与协议文档版本保持一致
- **增量验证**: 每次修改后运行分析工具确认

## 适用场景

此规则适用于：

- 全新协议配置创建
- 现有协议功能扩展  
- 协议版本升级
- 配置质量修复
- 多协议管理

无论何种场景，都遵循"差异修复优先，功能补充其次"的核心策略。
