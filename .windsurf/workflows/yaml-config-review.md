---
description: YAML配置审查工作流，从多视角检查协议配置的正确性
---

# YAML配置审查工作流

本工作流用于审查通过 `/protocol-to-yaml` 工作流生成的YAML配置文件。采用**多视角交叉验证**的方式，确保能发现配置错误。

---

## 审查原则

1. **独立视角**：审查时不依赖配置过程的记忆，重新从文档读取
2. **逐CMD验证**：每个CMD独立审查，避免批量审查导致遗漏
3. **双向对照**：文档→配置 和 配置→文档 双向检查
4. **自动化优先**：优先使用工具验证，人工审查作为补充

---

## 阶段一：自动化验证

### 1.1 配置语法验证

// turbo

```bash
python main.py --validate
```

检查点：

- [ ] 配置文件语法正确
- [ ] 所有引用的类型都已定义
- [ ] 所有引用的枚举都已定义
- [ ] 循环引用的id字段存在

### 1.2 解析测试（如有测试日志）

```bash
python main.py <protocol_name>
```

检查点：

- [ ] 解析过程无报错
- [ ] 所有CMD都能被识别
- [ ] 输出文件正常生成

---

## 阶段二：结构完整性审查

### 2.1 CMD覆盖率检查

**步骤A**：读取协议文档目录，提取所有CMD列表

```
读取文件: protocoltxt/<协议文档>.md，行范围: 1-200
```

**步骤B**：读取YAML配置，提取已配置的CMD列表

```
读取文件: configs/<protocol_name>/protocol.yaml
```

**步骤C**：对比检查

| 检查项 | 状态 |
|--------|------|
| 文档中的CMD是否都已配置 | |
| 配置中是否有文档中不存在的CMD | |
| CMD编号是否一致 | |

### 2.2 基础配置检查

检查 `meta` 部分：

- [ ] `protocol` 名称与目录名一致
- [ ] `default_endian` 设置正确

检查 `compatibility` 部分：

- [ ] `head_len` 与文档描述一致
- [ ] `tail_len` 与文档描述一致
- [ ] `frame_head` 与文档描述一致
- [ ] `head_fields` 各字段offset和length正确

---

## 阶段三：逐CMD深度审查（核心阶段）

### ⚠️ 重要原则

1. **每次只审查一个CMD**
2. **审查前必须重新读取该CMD对应的文档位置**
3. **使用检查清单逐项验证**
4. **发现问题立即记录，不要依赖记忆**

### 3.1 CMD审查循环

对于每个已配置的CMD，执行以下审查步骤：

#### 步骤A：读取文档中的CMD定义

```
读取文件: protocoltxt/<协议文档>.md
行范围: <该CMD的起始行>-<该CMD的结束行>
```

#### 步骤B：读取配置中的CMD定义

```
读取文件: configs/<protocol_name>/protocol.yaml
定位到: cmds.<cmd_id>
```

#### 步骤C：字段级对照检查

使用以下检查清单逐字段验证：

**字段数量检查**：

- [ ] 配置的字段数量与文档一致
- [ ] 没有遗漏字段
- [ ] 没有多余字段

**字段顺序检查**：

- [ ] 字段顺序与文档一致
- [ ] 循环结构内的字段顺序正确

**字段属性检查**（对每个字段）：

| 字段名 | len正确 | type正确 | enum正确 | scale正确 | 其他属性 |
|--------|---------|----------|----------|-----------|----------|
| 字段1  | | | | | |
| 字段2  | | | | | |
| ...    | | | | | |

#### 步骤D：特殊结构检查

**循环结构**：

- [ ] `repeat_by` 引用的id字段存在且在循环之前定义
- [ ] `repeat_const` 的次数与文档一致
- [ ] 循环内字段定义正确

**条件字段**：

- [ ] `when` 条件表达式语法正确
- [ ] 条件引用的id字段存在
- [ ] 条件逻辑与文档描述一致

**变长字段**：

- [ ] `len_by` 引用的id字段存在
- [ ] `len_to_end` 使用场景正确

#### 步骤E：记录审查结果

```markdown
### CMD <cmd_id> 审查结果

**状态**：✅ 通过 / ⚠️ 有问题 / ❌ 严重错误

**发现的问题**：
1. [问题描述]
2. [问题描述]

**修复建议**：
1. [修复方案]
2. [修复方案]
```

---

## 阶段四：交叉验证

### 4.1 枚举值验证

对于每个使用的枚举：

**步骤A**：在文档中查找该枚举的定义或使用场景

**步骤B**：对比配置中的枚举值

检查点：

- [ ] 枚举值完整（没有遗漏）
- [ ] 枚举值正确（数值和含义对应）
- [ ] 枚举名称有意义

### 4.2 类型定义验证

检查点：

- [ ] 所有使用的类型都已定义
- [ ] 类型的bytes属性正确
- [ ] BCD类型的字节数正确
- [ ] 位字段类型的order正确

支持的base类型：`uint`, `int`, `str`, `hex`, `bcd`, `time.cp56time2a`, `binary_str`, `bitset`, `bitfield`

### 4.3 bitfield/bit_groups验证

对于每个使用bit_groups的字段：

- [ ] start_bit起始位与文档一致
- [ ] width位宽度与文档一致
- [ ] 所有位段无重叠（start_bit + width不超过下一个的start_bit）
- [ ] 位段总宽度不超过类型字节数×8
- [ ] 枚举映射（如有）正确

### 4.4 缩放因子验证

对于每个带scale的字段：

- [ ] scale值与文档描述一致
- [ ] offset值（如有）与文档描述一致
- [ ] unit单位正确

---

## 阶段五：边界情况检查

### 5.1 字节对齐检查

计算每个CMD的总字节数，验证：

- [ ] 固定长度CMD的总字节数与文档一致
- [ ] 变长CMD的最小字节数合理

### 5.2 值域检查

对于数值字段：

- [ ] 类型能容纳文档描述的最大值
- [ ] 有符号/无符号选择正确

### 5.3 字符串长度检查

对于字符串字段：

- [ ] 长度与文档描述一致
- [ ] 编码类型正确（ASCII/UTF8）

---

## 阶段六：问题汇总与修复

### 6.1 问题分类

**严重问题**（必须修复）：

- 字段长度错误
- 字段顺序错误
- 循环结构错误
- 类型错误

**一般问题**（建议修复）：

- 枚举值不完整
- 缩放因子精度问题
- 字段名称不清晰

**轻微问题**（可选修复）：

- 注释不完整
- 单位缺失

### 6.2 修复执行

对于每个需要修复的问题：

1. 定位问题位置
2. 重新读取文档确认正确值
3. 执行修复
4. 重新验证

### 6.3 修复后验证

// turbo

```bash
python main.py --validate
```

---

## 审查检查清单模板

```markdown
## <protocol_name> 配置审查报告

### 基本信息
- 审查日期：
- 协议文档：
- 配置文件：

### 自动化验证
- [ ] 语法验证通过
- [ ] 解析测试通过

### 结构完整性
- [ ] CMD覆盖率 100%
- [ ] 基础配置正确

### CMD审查进度
| CMD | 状态 | 问题数 | 备注 |
|-----|------|--------|------|
| 1   |      |        |      |
| 2   |      |        |      |
| ... |      |        |      |

### 发现的问题
| 序号 | CMD | 严重程度 | 问题描述 | 修复状态 |
|------|-----|----------|----------|----------|
| 1    |     |          |          |          |
| 2    |     |          |          |          |

### 审查结论
- [ ] 配置质量合格，可以使用
- [ ] 需要修复后重新审查
```

---

## 常见错误模式

### 1. 字节长度错误

**症状**：解析结果偏移，后续字段值异常

**检查方法**：累加字段长度，与文档对比

### 2. 字节序错误

**症状**：数值大小异常（如应该是256却显示1）

**检查方法**：检查endian设置，对比文档

### 3. 循环次数错误

**症状**：循环解析不完整或越界

**检查方法**：检查repeat_by引用的字段，验证id是否正确

### 4. 枚举映射错误

**症状**：状态显示与实际不符

**检查方法**：逐个对比枚举值与文档定义

### 5. 缩放因子错误

**症状**：数值大小不合理（如电压显示2200V而非220V）

**检查方法**：检查scale值，验证计算公式

### 6. 条件字段遗漏

**症状**：某些情况下字段未解析

**检查方法**：检查when条件，验证所有分支

---

## 审查效率建议

1. **优先审查高频CMD**：先审查使用频率高的CMD
2. **批量检查同类问题**：如先检查所有枚举，再检查所有循环
3. **使用diff工具**：对比文档表格和配置结构
4. **保留审查记录**：便于追溯和复查

---

## 配置规范参考

完整的YAML配置规范请参考 `/protocol-to-yaml` 工作流中的“配置规范速查”章节，包含：

- **字段属性完整列表**：len, name, type, scale, offset, unit, enum, id, when, notes, endian, len_by, len_to_end, bit_groups
- **types支持的base类型**：uint, int, str, hex, bcd, time.cp56time2a, binary_str, bitset, bitfield
- **bitset类型定义**：每位独立命名
- **bitfield类型及bit_groups**：通用位段定义
- **head_fields头部字段定义**：offset, length, endian, type
- **枚举定义规范**
- **嵌套循环结构**
- **filters过滤器配置**
