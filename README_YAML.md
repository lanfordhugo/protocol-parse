# V8Parse - åŸºäºYAMLé…ç½®çš„åè®®è§£ææ¡†æ¶

## ğŸš€ é‡æ„å®Œæˆï¼

v8parseç°åœ¨å·²ç»å®Œå…¨é‡æ„ä¸ºåŸºäºYAMLé…ç½®çš„åè®®è§£ææ¡†æ¶ã€‚æ–°æ¶æ„æ›´ç®€æ´ã€æ›´çµæ´»ã€æ›´æ˜“äºç»´æŠ¤ã€‚

## âœ¨ æ–°æ¶æ„ç‰¹æ€§

### ğŸ¯ ç»Ÿä¸€çš„YAMLé…ç½®
- **å•æ–‡ä»¶é…ç½®**: æ¯ä¸ªåè®®åªéœ€ä¸€ä¸ª`protocol.yaml`æ–‡ä»¶
- **è‡ªæè¿°**: ç±»å‹å®šä¹‰ã€æšä¸¾ã€å­—æ®µå¸ƒå±€ã€è¿‡æ»¤å™¨å…¨éƒ¨åœ¨YAMLä¸­å®šä¹‰
- **é›¶ä»£ç æ·»åŠ åè®®**: æ–°åè®®æ— éœ€ä¿®æ”¹ä»»ä½•Pythonä»£ç 

### ğŸ”§ å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿ
- **å†…ç½®ç±»å‹**: uint8/16/32, ascii, hex, bcd, cp56time2a, binary_str, bitset
- **ç¼©æ”¾å’Œå•ä½**: è‡ªåŠ¨å¤„ç†æ•°å€¼ç¼©æ”¾å’Œå•ä½è½¬æ¢
- **æšä¸¾æ˜ å°„**: æ”¯æŒå€¼åˆ°åç§°çš„æ˜ å°„
- **å¾ªç¯ç»“æ„**: æ”¯æŒå›ºå®šæ¬¡æ•°å’ŒæŒ‰å­—æ®µå€¼å¾ªç¯

### ğŸ›¡ï¸ é…ç½®éªŒè¯
- **è¯­æ³•æ£€æŸ¥**: è‡ªåŠ¨éªŒè¯YAMLè¯­æ³•å’Œç»“æ„
- **è¯­ä¹‰æ£€æŸ¥**: æ£€æŸ¥ç±»å‹ä¸€è‡´æ€§ã€å­—æ®µå¼•ç”¨ã€å¾ªç¯é—­åˆç­‰
- **CIé›†æˆ**: å¯é›†æˆåˆ°æŒç»­é›†æˆæµç¨‹ä¸­

## ğŸ“ ç›®å½•ç»“æ„

```
v8parse/
â”œâ”€â”€ configs/                    # åè®®é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ v8/protocol.yaml       # V8åè®®é…ç½®
â”‚   â”œâ”€â”€ xiaoju/protocol.yaml   # å°æ¡”åè®®é…ç½®
â”‚   â”œâ”€â”€ yunwei/protocol.yaml   # è¿ç»´åè®®é…ç½®
â”‚   â””â”€â”€ sinexcel/protocol.yaml # Sinexcelåè®®é…ç½®
â”œâ”€â”€ src/                       # æ ¸å¿ƒè§£æå™¨
â”‚   â”œâ”€â”€ yaml_config.py         # YAMLé…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ yaml_field_parser.py   # å­—æ®µè§£æå™¨
â”‚   â”œâ”€â”€ yaml_cmdformat.py      # å‘½ä»¤æ ¼å¼ç®¡ç†å™¨
â”‚   â””â”€â”€ yaml_unified_protocol.py # ç»Ÿä¸€åè®®è§£æå™¨
â”œâ”€â”€ tools/
â”‚   â””â”€â”€ validate_configs.py    # é…ç½®éªŒè¯å·¥å…·
â”œâ”€â”€ main_yaml.py               # æ–°çš„ç®€åŒ–ä¸»ç¨‹åº
â””â”€â”€ main.py                    # å…¼å®¹çš„æ—§ä¸»ç¨‹åº
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è§£æåè®®æ•°æ®

```bash
# ä½¿ç”¨æ–°çš„ç®€åŒ–ä¸»ç¨‹åº
python main_yaml.py v8        # è§£æV8åè®®
python main_yaml.py xiaoju    # è§£æå°æ¡”åè®®
python main_yaml.py yunwei    # è§£æè¿ç»´åè®®
python main_yaml.py sinexcel  # è§£æSinexcelåè®®

# åˆ—å‡ºæ‰€æœ‰å¯ç”¨åè®®
python main_yaml.py --list

# éªŒè¯æ‰€æœ‰é…ç½®
python main_yaml.py --validate
```

### 2. æ·»åŠ æ–°åè®®

åªéœ€ä¸¤æ­¥å³å¯æ·»åŠ æ–°åè®®ï¼š

1. **åˆ›å»ºé…ç½®æ–‡ä»¶**: åœ¨`configs/new_protocol/`ç›®å½•ä¸‹åˆ›å»º`protocol.yaml`
2. **æ”¾ç½®æ—¥å¿—æ–‡ä»¶**: å°†æ—¥å¿—æ–‡ä»¶æ”¾åˆ°`input_logs/new_protocol.log`

ç¤ºä¾‹é…ç½®ï¼š
```yaml
meta:
  protocol: new_protocol
  version: 1
  default_endian: LE

types:
  uint8:  { base: uint, bytes: 1, signed: false }
  uint16: { base: uint, bytes: 2, signed: false }
  ascii:  { base: str,  encoding: ASCII }

cmds:
  1:
    - {len: 1, name: çŠ¶æ€, type: uint8}
    - {len: 32, name: è®¾å¤‡ç¼–ç , type: ascii}

filters:
  include_cmds: []
  exclude_cmds: []
```

## ğŸ“‹ YAMLé…ç½®è¯¦è§£

### åŸºæœ¬ç»“æ„

```yaml
meta:                          # åè®®å…ƒæ•°æ®
  protocol: v8                 # åè®®åç§°
  version: 1                   # é…ç½®ç‰ˆæœ¬
  default_endian: LE           # é»˜è®¤å­—èŠ‚åº (LE/BE)
  notes: å¯é€‰è¯´æ˜

types:                         # ç±»å‹å®šä¹‰
  uint8:   { base: uint, bytes: 1, signed: false }
  ascii:   { base: str,  encoding: ASCII }
  bcd2:    { base: bcd, bytes: 2 }
  
enums:                         # æšä¸¾å®šä¹‰
  status:
    0: ç¦»çº¿
    1: åœ¨çº¿

cmds:                          # å‘½ä»¤å®šä¹‰
  1:                           # å‘½ä»¤ID
    - {len: 1, name: çŠ¶æ€, type: uint8, enum: status}
    - {len: 4, name: ç”µå‹, type: uint32, scale: 0.1, unit: V}

filters:                       # è¿‡æ»¤å™¨
  include_cmds: [1, 2, 3]      # åŒ…å«çš„å‘½ä»¤
  exclude_cmds: []             # æ’é™¤çš„å‘½ä»¤
```

### æ”¯æŒçš„æ•°æ®ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| uint | æ— ç¬¦å·æ•´æ•° | `{base: uint, bytes: 2, signed: false}` |
| int | æœ‰ç¬¦å·æ•´æ•° | `{base: int, bytes: 2, signed: true}` |
| str | å­—ç¬¦ä¸² | `{base: str, encoding: ASCII}` |
| hex | åå…­è¿›åˆ¶ | `{base: hex}` |
| bcd | BCDç  | `{base: bcd, bytes: 2}` |
| cp56time2a | IECæ—¶é—´ | `{base: time.cp56time2a, bytes: 7}` |
| binary_str | äºŒè¿›åˆ¶ä¸² | `{base: binary_str, bytes: 4}` |
| bitset | ä½æ®µ | `{base: bitset, bits: [{name: "bit0"}]}` |

### å¾ªç¯ç»“æ„

```yaml
# å›ºå®šæ¬¡æ•°å¾ªç¯
- repeat_const: 28
  fields:
    - {len: 1, name: æªçŠ¶æ€, type: uint8}
    - {len: 2, name: æªç”µå‹, type: uint16}

# æŒ‰å­—æ®µå€¼å¾ªç¯
- {len: 1, name: æ—¶æ®µæ•°é‡, type: uint8, id: period_count}
- repeat_by: period_count
  fields:
    - {len: 2, name: å¼€å§‹æ—¶é—´, type: uint16}
    - {len: 2, name: ç»“æŸæ—¶é—´, type: uint16}
```

## ğŸ› ï¸ é…ç½®éªŒè¯

ä½¿ç”¨å†…ç½®çš„é…ç½®éªŒè¯å·¥å…·ï¼š

```bash
# éªŒè¯å•ä¸ªé…ç½®
python tools/validate_configs.py configs/v8/protocol.yaml

# éªŒè¯æ‰€æœ‰é…ç½®
python tools/validate_configs.py --all

# é›†æˆåˆ°ä¸»ç¨‹åº
python main_yaml.py --validate
```

## ğŸ”„ å…¼å®¹æ€§

- **å‘å‰å…¼å®¹**: æ—§çš„`main.py`ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨YAMLé…ç½®
- **æ¸è¿›è¿ç§»**: å¯ä»¥é€ä¸ªåè®®è¿ç§»åˆ°YAMLé…ç½®
- **é…ç½®å…±å­˜**: YAMLé…ç½®ä¸åŸæœ‰é…ç½®æ–‡ä»¶å¯ä»¥å…±å­˜

## ğŸ¯ ä¼˜åŠ¿å¯¹æ¯”

### æ—§æ¶æ„ vs æ–°æ¶æ„

| ç‰¹æ€§ | æ—§æ¶æ„ | æ–°æ¶æ„ |
|------|--------|--------|
| é…ç½®æ–‡ä»¶ | 3ä¸ªæ–‡ä»¶ (format.txt, field_types.ini, filter.txt) | 1ä¸ªæ–‡ä»¶ (protocol.yaml) |
| æ·»åŠ åè®® | éœ€è¦ä¿®æ”¹Pythonä»£ç  | é›¶ä»£ç ï¼Œåªéœ€YAMLé…ç½® |
| ç±»å‹ç³»ç»Ÿ | ç¡¬ç¼–ç åœ¨è§£æå™¨ä¸­ | çµæ´»çš„YAMLç±»å‹å®šä¹‰ |
| é…ç½®éªŒè¯ | æ—  | å®Œæ•´çš„è¯­æ³•å’Œè¯­ä¹‰æ£€æŸ¥ |
| å¯è¯»æ€§ | åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ | å•æ–‡ä»¶è‡ªæè¿° |
| ç»´æŠ¤æ€§ | éœ€è¦ç†è§£ä»£ç é€»è¾‘ | ç›´è§‚çš„YAMLé…ç½® |

## ğŸ”§ å¼€å‘è€…æŒ‡å—

### æ‰©å±•ç±»å‹ç³»ç»Ÿ

è¦æ·»åŠ æ–°çš„æ•°æ®ç±»å‹ï¼Œåªéœ€åœ¨`src/yaml_field_parser.py`ä¸­ï¼š

1. åœ¨`_build_type_parsers()`ä¸­æ·»åŠ è§£æå™¨
2. å®ç°å¯¹åº”çš„`_parse_xxx()`æ–¹æ³•

### æ‰©å±•éªŒè¯è§„åˆ™

åœ¨`tools/validate_configs.py`ä¸­æ·»åŠ æ–°çš„éªŒè¯è§„åˆ™ã€‚

### æ€§èƒ½ä¼˜åŒ–

- YAMLé…ç½®åœ¨é¦–æ¬¡åŠ è½½åä¼šç¼“å­˜
- å­—æ®µè§£æå™¨ä½¿ç”¨é¢„ç¼–è¯‘çš„ç±»å‹æ˜ å°„
- æ”¯æŒå¹¶è¡Œå¤„ç†å¤šä¸ªåè®®

## ğŸ‰ æ€»ç»“

æ–°çš„YAMLé…ç½®æ¶æ„è®©v8parseå˜å¾—ï¼š
- âœ… **æ›´ç®€å•**: é›¶ä»£ç æ·»åŠ åè®®
- âœ… **æ›´çµæ´»**: ä¸°å¯Œçš„ç±»å‹ç³»ç»Ÿå’Œé…ç½®é€‰é¡¹  
- âœ… **æ›´å¯é **: å®Œæ•´çš„é…ç½®éªŒè¯
- âœ… **æ›´æ˜“ç»´æŠ¤**: è‡ªæè¿°çš„é…ç½®æ–‡ä»¶
- âœ… **æ›´æ˜“æ‰©å±•**: æ’ä»¶åŒ–çš„è§£æå™¨æ¶æ„

æ¬¢è¿ä½¿ç”¨æ–°çš„YAMLé…ç½®ç³»ç»Ÿï¼ğŸŠ
