# ==================================================================================
# 云快充平台协议V1.6配置文件
# ==================================================================================

# 协议基本信息
meta:
  protocol: yunkuaichong
  version: 1.6
  default_endian: LE
  notes: 云快充平台协议V1.6 - 充电桩与云快充服务平台交互协议

# 协议兼容性配置
compatibility:
  head_len: 6                     # 报文头长度（字节数）
  tail_len: 2                     # 报文尾长度（字节数）  
  frame_head: "68"               # 帧头标识（16进制字符串）
  
  # 头部字段定义 - 从报文头中提取关键信息
  head_fields:
    - {name: "frame_type", offset: 4, length: 1, endian: "little", type: "uint"}    # 帧类型码
    - {name: "sequence", offset: 2, length: 2, endian: "little", type: "uint"}      # 序列号
    - {name: "encrypt_flag", offset: 3, length: 1, endian: "little", type: "uint"}  # 加密标志
    - {name: "data_length", offset: 1, length: 1, endian: "little", type: "uint"}   # 数据长度

# 数据类型定义
types:
  # 基础整数类型
  uint8:   { base: uint, bytes: 1, signed: false }
  uint16:  { base: uint, bytes: 2, signed: false }
  uint32:  { base: uint, bytes: 4, signed: false }
  
  # 字符串类型
  ascii:   { base: str,  encoding: ASCII }
  
  # 特殊显示类型
  hex:     { base: hex }
  
  # BCD码类型
  bcd1:    { base: bcd, bytes: 1 }
  bcd2:    { base: bcd, bytes: 2 }
  bcd7:    { base: bcd, bytes: 7 }
  bcd10:   { base: bcd, bytes: 10 }
  bcd16:   { base: bcd, bytes: 16 }
  bcd8:    { base: bcd, bytes: 8 }
  
  # 时间类型
  cp56time2a: { base: time.cp56time2a, bytes: 7 }
  bcd_time7:  { base: time.bcd7, bytes: 7 }   # BCD时间 YYYYMMDDhhmmss (7字节)
  bcd_time8:  { base: time.bcd8, bytes: 8 }   # BCD时间 YYYYMMDDhhmmss + 空字节 (8字节)
  unix_time:  { base: time.unix, bytes: 4 }   # Unix时间戳（秒）
  unix_time_ms: { base: time.unix_ms, bytes: 8 }  # Unix时间戳（毫秒）
  

# 枚举定义
enums:
  # 登录结果枚举
  login_result:
    0: 登陆成功
    1: 登陆失败
  
  # 桩类型枚举（协议定义：0=直流，1=交流）
  pile_type:
    0: 直流
    1: 交流
    2: 交直流一体
  
  # 网络连接类型枚举（协议定义：0x00=SIM卡，0x01=LAN，0x02=WAN，0x03=其他）
  network_type:
    0: SIM卡
    1: LAN
    2: WAN
    3: 其他
  
  # 运营商枚举
  operator:
    0: 移动
    2: 电信
    3: 联通
    4: 其他
  
  # 枪状态枚举
  gun_status:
    0: 正常
    1: 故障
  

# 命令定义
cmds:
  # --------------------------------------------------------------------------------
  # 0x01：充电桩登录认证
  # --------------------------------------------------------------------------------
  1:
    - {len: 7, name: 桩编码, type: bcd7}                                        # 桩编码，不足7位补0
    - {len: 1, name: 桩类型, type: uint8, enum: pile_type}                      # 桩类型：0=直流，1=交流
    - {len: 1, name: 充电枪数量, type: uint8}                                   # 充电枪数量
    - {len: 1, name: 通信协议版本, type: uint8}                                 # 通信协议版本，版本号乘10，v1.0=0x0A
    - {len: 8, name: 程序版本, type: ascii}                                     # 程序版本，不足8位补零
    - {len: 1, name: 网络连接类型, type: uint8, enum: network_type}             # 网络连接类型
    - {len: 10, name: SIM卡, type: bcd10}                                       # SIM卡号，不足10位补零
    - {len: 1, name: 运营商, type: uint8, enum: operator}                       # 运营商
  
  # --------------------------------------------------------------------------------
  # 0x02：登录认证应答
  # --------------------------------------------------------------------------------
  2:
    - {len: 7, name: 桩编码, type: bcd7}                                        # 桩编码
    - {len: 1, name: 登陆结果, type: uint8, enum: login_result}                 # 登陆结果
  
  # --------------------------------------------------------------------------------
  # 0x03：充电桩心跳包
  # --------------------------------------------------------------------------------
  3:
    - {len: 7, name: 桩编码, type: bcd7}                                        # 桩编码
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 1, name: 枪状态, type: uint8, enum: gun_status}                     # 枪状态
  
  # --------------------------------------------------------------------------------
  # 0x04：心跳包应答
  # --------------------------------------------------------------------------------
  4:
    - {len: 7, name: 桩编码, type: bcd7}                                        # 桩编码
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 1, name: 心跳应答, type: uint8}                                     # 心跳应答，置0
  
  # --------------------------------------------------------------------------------
  # 0x05：计费模型验证请求
  # --------------------------------------------------------------------------------
  5:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 2, name: 计费模型编号, type: bcd2}                                  # 计费模型编号，首次连接到平台时置零
  
  # --------------------------------------------------------------------------------
  # 0x06：计费模型验证请求应答
  # --------------------------------------------------------------------------------
  6:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 2, name: 计费模型编号, type: bcd2}                                  # 计费模型编号
    - {len: 1, name: 验证结果, type: uint8}                                     # 验证结果：0x00一致，0x01不一致
  
  # --------------------------------------------------------------------------------
  # 0x09：充电桩计费模型请求
  # --------------------------------------------------------------------------------
  9:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
  
  # --------------------------------------------------------------------------------
  # 0x0A：计费模型请求应答
  # --------------------------------------------------------------------------------
  10:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 2, name: 计费模型编号, type: bcd2}                                  # 计费模型编号
    - {len: 4, name: 尖电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 尖服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 4, name: 峰电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 峰服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 4, name: 平电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 平服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 4, name: 谷电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 谷服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 1, name: 计损比例, type: uint8}                                     # 计损比例
    - {len: 48, name: 时段费率号, type: hex}                                    # 48段费率号，每段1字节：0x00尖，0x01峰，0x02平，0x03谷
  
  # --------------------------------------------------------------------------------
  # 0x12：读取实时监测数据
  # --------------------------------------------------------------------------------
  18:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
  
  # --------------------------------------------------------------------------------
  # 0x13：上传实时监测数据
  # --------------------------------------------------------------------------------
  19:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 1, name: 状态, type: uint8}                                         # 状态：0x00离线，0x01故障，0x02空闲，0x03充电
    - {len: 1, name: 枪是否归位, type: uint8}                                   # 0x00否，0x01是，0x02未知
    - {len: 1, name: 是否插枪, type: uint8}                                     # 0x00否，0x01是
    - {len: 2, name: 输出电压, type: uint16, scale: 0.1, unit: "V"}            # 精确到小数点后一位
    - {len: 2, name: 输出电流, type: uint16, scale: 0.1, unit: "A"}            # 精确到小数点后一位
    - {len: 1, name: 枪线温度, type: uint8, offset: -50, unit: "℃"}            # 整形，偏移量-50
    - {len: 8, name: 枪线编码, type: hex}                                       # 没有置零
    - {len: 1, name: SOC, type: uint8, unit: "%"}                              # 待机置零，交流桩置零
    - {len: 1, name: 电池组最高温度, type: uint8, offset: -50, unit: "℃"}      # 整形，偏移量-50℃
    - {len: 2, name: 累计充电时间, type: uint16, unit: "min"}                   # 单位：min
    - {len: 2, name: 剩余时间, type: uint16, unit: "min"}                       # 单位：min
    - {len: 4, name: 充电度数, type: uint32, scale: 0.0001, unit: "kWh"}       # 精确到小数点后四位
    - {len: 4, name: 计损充电度数, type: uint32, scale: 0.0001, unit: "kWh"}   # 精确到小数点后四位
    - {len: 4, name: 已充金额, type: uint32, scale: 0.0001, unit: "元"}        # 精确到小数点后四位
    - {len: 2, name: 硬件故障, type: binary_str_2bytes}                         # Bit位表示
  
  # --------------------------------------------------------------------------------
  # 0x31：充电桩主动申请启动充电
  # --------------------------------------------------------------------------------
  49:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 1, name: 启动方式, type: uint8}                                     # 0x01刷卡启动，0x02帐号启动，0x03 VIN码启动
    - {len: 1, name: 是否需要密码, type: uint8}                                 # 0x00不需要，0x01需要
    - {len: 8, name: 账号或物理卡号, type: hex}                                 # 不足8位补0
    - {len: 16, name: 输入密码, type: hex}                                      # 16位MD5加密
    - {len: 17, name: VIN码, type: ascii}                                       # VIN码启动时上送，其他方式置零，需反序上送
  
  # --------------------------------------------------------------------------------
  # 0x32：运营平台确认启动充电
  # --------------------------------------------------------------------------------
  50:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 8, name: 逻辑卡号, type: bcd8}                                      # 显示在屏幕上，不足8位补零
    - {len: 4, name: 账户余额, type: uint32, scale: 0.01, unit: "元"}          # 保留两位小数
    - {len: 1, name: 鉴权成功标志, type: uint8}                                 # 0x00失败，0x01成功
    - {len: 1, name: 失败原因, type: uint8}                                     # 失败原因码
  
  # --------------------------------------------------------------------------------
  # 0x3B：交易记录
  # --------------------------------------------------------------------------------
  59:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 7, name: 开始时间, type: cp56time2a}                                # CP56Time2a格式
    - {len: 7, name: 结束时间, type: cp56time2a}                                # CP56Time2a格式
    - {len: 4, name: 尖单价, type: uint32, scale: 0.00001, unit: "元/kWh"}     # 精确到小数点后五位
    - {len: 4, name: 尖电量, type: uint32, scale: 0.0001, unit: "kWh"}         # 精确到小数点后四位
    - {len: 4, name: 计损尖电量, type: uint32, scale: 0.0001, unit: "kWh"}     # 精确到小数点后四位
    - {len: 4, name: 尖金额, type: uint32, scale: 0.0001, unit: "元"}          # 精确到小数点后四位
    - {len: 4, name: 峰单价, type: uint32, scale: 0.00001, unit: "元/kWh"}     # 精确到小数点后五位
    - {len: 4, name: 峰电量, type: uint32, scale: 0.0001, unit: "kWh"}         # 精确到小数点后四位
    - {len: 4, name: 计损峰电量, type: uint32, scale: 0.0001, unit: "kWh"}     # 精确到小数点后四位
    - {len: 4, name: 峰金额, type: uint32, scale: 0.0001, unit: "元"}          # 精确到小数点后四位
    - {len: 4, name: 平单价, type: uint32, scale: 0.00001, unit: "元/kWh"}     # 精确到小数点后五位
    - {len: 4, name: 平电量, type: uint32, scale: 0.0001, unit: "kWh"}         # 精确到小数点后四位
    - {len: 4, name: 计损平电量, type: uint32, scale: 0.0001, unit: "kWh"}     # 精确到小数点后四位
    - {len: 4, name: 平金额, type: uint32, scale: 0.0001, unit: "元"}          # 精确到小数点后四位
    - {len: 4, name: 谷单价, type: uint32, scale: 0.00001, unit: "元/kWh"}     # 精确到小数点后五位
    - {len: 4, name: 谷电量, type: uint32, scale: 0.0001, unit: "kWh"}         # 精确到小数点后四位
    - {len: 4, name: 计损谷电量, type: uint32, scale: 0.0001, unit: "kWh"}     # 精确到小数点后四位
    - {len: 4, name: 谷金额, type: uint32, scale: 0.0001, unit: "元"}          # 精确到小数点后四位
    - {len: 5, name: 电表总起值, type: hex}                                     # 精确到小数点后四位，5字节
    - {len: 5, name: 电表总止值, type: hex}                                     # 精确到小数点后四位，5字节
    - {len: 4, name: 总电量, type: uint32, scale: 0.0001, unit: "kWh"}         # 精确到小数点后四位
    - {len: 4, name: 计损总电量, type: uint32, scale: 0.0001, unit: "kWh"}     # 精确到小数点后四位
    - {len: 4, name: 消费金额, type: uint32, scale: 0.0001, unit: "元"}        # 精确到小数点后四位
    - {len: 17, name: 电动汽车唯一标识, type: ascii}                            # VIN码
    - {len: 1, name: 交易标识, type: uint8}                                     # 0x01 app启动，0x02卡启动，0x04离线卡启动，0x05 vin码启动
    - {len: 7, name: 交易日期时间, type: cp56time2a}                            # CP56Time2a格式
    - {len: 1, name: 停止原因, type: uint8}                                     # 见附录
    - {len: 8, name: 物理卡号, type: hex}                                       # 不足8位补0

  # --------------------------------------------------------------------------------
  # 0x33：远程启动充电命令回复
  # --------------------------------------------------------------------------------
  51:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 1, name: 启动结果, type: uint8}                                     # 0x00失败，0x01成功
    - {len: 1, name: 失败原因, type: uint8}                                     # 失败原因码

  # --------------------------------------------------------------------------------
  # 0x34：运营平台远程控制启机
  # --------------------------------------------------------------------------------
  52:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 8, name: 逻辑卡号, type: bcd8}                                      # 显示在屏幕上，不足8位补零
    - {len: 8, name: 物理卡号, type: hex}                                       # 不足8位补零
    - {len: 4, name: 账户余额, type: uint32, scale: 0.01, unit: "元"}          # 保留到小数点两位

  # --------------------------------------------------------------------------------
  # 0x35：远程停机命令回复
  # --------------------------------------------------------------------------------
  53:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 1, name: 停止结果, type: uint8}                                     # 0x00失败，0x01成功
    - {len: 1, name: 失败原因, type: uint8}                                     # 失败原因码

  # --------------------------------------------------------------------------------
  # 0x36：运营平台远程停机
  # --------------------------------------------------------------------------------
  54:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号

  # --------------------------------------------------------------------------------
  # 0x40：交易记录确认
  # --------------------------------------------------------------------------------
  64:
    - {len: 16, name: 交易流水号, type: bcd16}                                  # 交易流水号
    - {len: 1, name: 确认结果, type: uint8}                                     # 0x00上传成功，0x01非法账单

  # --------------------------------------------------------------------------------
  # 0x41：余额更新应答
  # --------------------------------------------------------------------------------
  65:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 8, name: 物理卡号, type: hex}                                       # 不足8位补零
    - {len: 1, name: 修改结果, type: uint8}                                     # 0x00成功，0x01设备编号错误，0x02卡号错误

  # --------------------------------------------------------------------------------
  # 0x42：远程账户余额更新
  # --------------------------------------------------------------------------------
  66:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 枪号, type: bcd1}                                          # 枪号
    - {len: 8, name: 物理卡号, type: hex}                                       # 不足8位补零
    - {len: 4, name: 修改后账户金额, type: uint32, scale: 0.01, unit: "元"}    # 保留两位小数

  # --------------------------------------------------------------------------------
  # 0x51：充电桩工作参数设置应答
  # --------------------------------------------------------------------------------
  81:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 设置结果, type: uint8}                                     # 0x00失败，0x01成功

  # --------------------------------------------------------------------------------
  # 0x52：充电桩工作参数设置
  # --------------------------------------------------------------------------------
  82:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 是否允许工作, type: uint8}                                 # 0x00允许正常工作，0x01停止使用
    - {len: 1, name: 充电桩最大允许输出功率, type: uint8, unit: "%"}           # 1BIN表示1%，最大100%，最小30%

  # --------------------------------------------------------------------------------
  # 0x55：对时设置应答
  # --------------------------------------------------------------------------------
  85:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 7, name: 当前时间, type: cp56time2a}                                # CP56Time2a格式

  # --------------------------------------------------------------------------------
  # 0x56：对时设置
  # --------------------------------------------------------------------------------
  86:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 7, name: 当前时间, type: cp56time2a}                                # CP56Time2a格式

  # --------------------------------------------------------------------------------
  # 0x57：计费模型应答
  # --------------------------------------------------------------------------------
  87:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 2, name: 计费模型编号, type: bcd2}                                  # 计费模型编号
    - {len: 1, name: 设置结果, type: uint8}                                     # 0x00失败，0x01成功

  # --------------------------------------------------------------------------------
  # 0x58：计费模型设置
  # --------------------------------------------------------------------------------
  88:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号，不足7位补0
    - {len: 2, name: 计费模型编码, type: bcd2}                                  # 计费模型编码
    - {len: 4, name: 尖电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 尖服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 4, name: 峰电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 峰服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 4, name: 平电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 平服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 4, name: 谷电费费率, type: uint32, scale: 0.00001, unit: "元/kWh"}  # 精确到五位小数
    - {len: 4, name: 谷服务费费率, type: uint32, scale: 0.00001, unit: "元/kWh"} # 精确到五位小数
    - {len: 1, name: 计损比例, type: uint8}                                     # 计损比例
    - {len: 48, name: 时段费率号, type: hex}                                    # 48段费率号

  # --------------------------------------------------------------------------------
  # 0x91：远程重启应答
  # --------------------------------------------------------------------------------
  145:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 设置结果, type: uint8}                                     # 0x00失败，0x01成功

  # --------------------------------------------------------------------------------
  # 0x92：远程重启
  # --------------------------------------------------------------------------------
  146:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 执行控制, type: uint8}                                     # 0x01立即执行，0x02空闲执行

  # --------------------------------------------------------------------------------
  # 0x93：远程更新应答
  # --------------------------------------------------------------------------------
  147:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 升级状态, type: uint8}                                     # 0x00成功，0x01编号错误，0x02程序与桩型号不符，0x03下载超时

  # --------------------------------------------------------------------------------
  # 0x94：远程更新
  # --------------------------------------------------------------------------------
  148:
    - {len: 7, name: 桩编号, type: bcd7}                                        # 桩编号
    - {len: 1, name: 桩型号, type: uint8}                                       # 0x01直流，0x02交流
    - {len: 2, name: 桩功率, type: uint16}                                      # 不足2位补零
    - {len: 16, name: 升级服务器地址, type: ascii}                              # 不足16位补零
    - {len: 2, name: 升级服务器端口, type: uint16}                              # 不足2位补零
    - {len: 16, name: 用户名, type: ascii}                                      # 不足16位补零
    - {len: 16, name: 密码, type: ascii}                                        # 不足16位补零
    - {len: 32, name: 文件路径, type: ascii}                                    # 不足32位补零
    - {len: 1, name: 执行控制, type: uint8}                                     # 0x01立即执行，0x02空闲执行
    - {len: 1, name: 下载超时时间, type: uint8, unit: "min"}                   # 单位：min

# 过滤器配置
filters:
  include_cmds: []
  exclude_cmds: []
